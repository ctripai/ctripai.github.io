<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>数学王国大闯关 - 二年级版</title>
<style>
* {margin:0;padding:0;box-sizing:border-box;font-family:"幼圆","微软雅黑",Arial, sans-serif;}

/* 手机端全屏显示游戏区域 */
body {
    background:linear-gradient(#fdf2f8, #fef7fb);
    min-height:100vh;
    display:flex;
    flex-direction:column;
    align-items:center;
    padding:0;
    overflow-x:hidden;
    width:100vw;
    background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M54.627 0h-51.254c-1.86 0-3.373 1.513-3.373 3.373v51.254c0 1.86 1.513 3.373 3.373 3.373h51.254c1.86 0 3.373-1.513 3.373-3.373v-51.254c0-1.86-1.513-3.373-3.373-3.373zm-2.915 54.627c0 0.818-0.665 1.483-1.483 1.483h-45.428c-0.818 0-1.483-0.665-1.483-1.483v-45.428c0-0.818 0.665-1.483 1.483-1.483h45.428c0.818 0 1.483 0.665 1.483 1.483v45.428z' fill='%23ffeb3b' fill-opacity='0.1' fill-rule='evenodd'/%3E%3C/svg%3E");
}

.game-container {
    width:100%;
    max-width:100%;
    min-height:100vh;
    background:#fff;
    border-radius:0;
    box-shadow:none;
    padding:20px 15px;
    text-align:center;
    border:none;
    position:relative;
    z-index:10;
    display:flex;
    flex-direction:column;
    justify-content: flex-start;
    gap: 12px; /* 适度的间距，更友好 */
}

/* 优化：称号+星星合并展示区 */
.info-bar {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    align-items: center;
    gap: 10px;
    margin: 5px 0;
}

/* 称号展示区 */
.user-title {
    font-size:16px; /* 适配二年级视觉的字体大小 */
    color:#ff9800;
    background: rgba(255, 152, 0, 0.1);
    padding:4px 12px;
    border-radius:20px;
    font-weight:bold;
    display: none;
    border: 2px solid #ffcc80;
    box-shadow: 0 2px 4px rgba(255, 152, 0, 0.1);
}

/* 星星累计 */
.score-box {
    font-size:16px; /* 简化字号，适配二年级 */
    color:#e91e63;
    font-weight:bold;
    display: flex;
    align-items: center;
    gap: 3px;
}

.score-box::before {
    content: "⭐";
    font-size: 18px;
}

/* 关卡信息 */
.level-info {
    font-size:18px; /* 优化字号 */
    color:#2196f3;
    margin:0 auto;
    background:#e3f2fd;
    padding:6px 12px;
    border-radius:10px;
    display:inline-block;
    border: 2px solid #bbdefb;
    font-weight: bold;
}

.title {
    color:#e91e63;
    font-size:28px; /* 优化标题大小，更适合二年级 */
    margin-bottom:5px;
    text-shadow:2px 2px 4px rgba(233, 30, 99, 0.2);
    font-weight:bold;
    letter-spacing: 1px;
}

/* 新增：卡通进度条样式 */
.progress-bar {
    width: 95%;
    max-width: 420px;
    margin: 0 auto;
    padding: 8px 12px;
    background: #f0f8fb;
    border-radius: 20px;
    border: 2px solid #e1f5fe;
}

.progress-title {
    font-size:14px; /* 简化进度标题字号 */
    color:#2196f3;
    margin-bottom:6px;
    font-weight: bold;
}

.progress-stars {
    display: flex;
    justify-content: center;
    gap: 8px;
}

.star-icon {
    font-size:20px; /* 优化星星大小 */
    color: #e0e0e0;
    transition: all 0.3s ease;
}

.star-icon.active {
    color: #ffd700;
    text-shadow: 0 0 6px rgba(255, 215, 0, 0.5);
    transform: scale(1.05);
}

/* 核心优化：算式和答案区样式 */
.question-box {
    font-size:26px; /* 优化算式字体，更适合二年级 */
    margin:8px auto;
    padding:25px 20px;
    background: linear-gradient(135deg, #fff9c4 0%, #fff59d 100%);
    border-radius:25px;
    border:4px solid #ffc107;
    font-weight:bold;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-wrap: wrap;
    white-space: normal;
    overflow: hidden;
    position: relative;
    box-shadow:0 6px 15px rgba(255, 193, 7, 0.2);
    letter-spacing: 1px;
    gap: 15px;
    width: 95%;
    max-width: 420px;
}

/* 加载动画 */
.loading-spinner {
    position: absolute;
    top: 50%;
    right: 20px;
    transform: translateY(-50%);
    width: 25px;
    height: 25px;
    border: 3px solid #ffc107;
    border-top: 3px solid transparent;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    display: none;
}

@keyframes spin {
    0% { transform: translateY(-50%) rotate(0deg); }
    100% { transform: translateY(-50%) rotate(360deg); }
}

.question-part {
    color:#333;
    line-height: 1.5;
    flex-shrink: 1;
    max-width: calc(100% - 110px);
    text-align: right;
}

.answer-display {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 100px;
    height: 55px;
    font-size:26px; /* 优化答案字体 */
    text-align: center;
    color:#2e7d32;
    font-weight: bold;
    background:#f1f8e9;
    border-radius: 15px;
    padding: 0 20px;
    vertical-align: middle;
    box-shadow:inset 0 3px 6px rgba(0,0,0,0.05);
    transition:all 0.2s ease;
    border:3px solid #c8e6c9;
    flex-shrink: 0;
    cursor: pointer;
}

.answer-display.has-value {
    border-color:#81c784;
    transform:scale(1.03);
    box-shadow:inset 0 3px 6px rgba(0,0,0,0.05), 0 3px 8px rgba(144, 238, 144, 0.4);
}

/* 符合儿童直觉的数字键盘 */
.num-keyboard {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 15px; /* 更大的按键间距 */
    width: 100%;
    max-width: 400px;
    margin: 15px auto 0;
    padding: 20px;
    background: #f5f5f5;
    border-radius: 30px;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
    flex-shrink: 0;
    border: 3px solid #eeeeee;
}

/* 新增：强化按键反馈样式 */
.num-btn {
    padding: 25px 0;
    font-size: 26px; /* 优化按键字体 */
    border: none;
    border-radius: 20px;
    cursor: pointer;
    color: #fff;
    font-weight: 600;
    box-shadow: 0 5px 10px rgba(0, 0, 0, 0.15);
    transition: all 0.15s ease;
    position: relative;
    overflow: hidden;
    /* 扩大点击热区 */
    margin: -5px;
    z-index: 1;
}

/* 卡通化按键配色 */
.num-btn[data-num="1"] { grid-area: 1 / 1 / 2 / 2; background: #66bb6a; }
.num-btn[data-num="2"] { grid-area: 1 / 2 / 2 / 3; background: #42a5f5; }
.num-btn[data-num="3"] { grid-area: 1 / 3 / 2 / 4; background: #ec407a; }
.num-btn[data-num="4"] { grid-area: 2 / 1 / 3 / 2; background: #ffa726; }
.num-btn[data-num="5"] { grid-area: 2 / 2 / 3 / 3; background: #9c27b0; }
.num-btn[data-num="6"] { grid-area: 2 / 3 / 3 / 4; background: #26c6da; }
.num-btn[data-num="7"] { grid-area: 3 / 1 / 4 / 2; background: #ef5350; }
.num-btn[data-num="8"] { grid-area: 3 / 2 / 4 / 3; background: #7e57c2; }
.num-btn[data-num="9"] { grid-area: 3 / 3 / 4 / 4; background: #26a69a; }
.num-btn.del-btn { 
    grid-area: 4 / 1 / 5 / 2; 
    background: #ff7043;
    font-size: 22px;
}
.num-btn.zero-btn { 
    grid-area: 4 / 2 / 5 / 4; 
    background: #1976d2;
}

/* 新增：按键点击反馈动画 */
.num-btn:active {
    transform: translateY(4px) scale(0.95);
    box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
    opacity: 0.9;
    animation: flash 0.2s ease;
}

@keyframes flash {
    0% { filter: brightness(1); }
    50% { filter: brightness(1.2); }
    100% { filter: brightness(1); }
}

/* 答案输入弹跳动画 */
.answer-display.has-value {
    animation: bounce 0.3s ease;
}

@keyframes bounce {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1.03); }
}

@media (hover: hover) {
    .num-btn:hover {
        opacity: 0.95;
        box-shadow: 0 7px 15px rgba(0, 0, 0, 0.2);
        transform: translateY(-2px);
    }
}

/* 响应式：小屏幕优化 */
@media (max-width: 375px) {
    .num-keyboard {
        gap: 12px;
        max-width: 320px;
        padding: 15px;
    }
    .num-btn {
        padding: 20px 0;
        font-size: 24px;
        border-radius: 18px;
    }
    .question-box {
        font-size: 24px;
        padding: 20px 15px;
        width: 95%;
    }
    .answer-display {
        font-size: 24px;
        min-width: 90px;
        height: 50px;
    }
    .title {
        font-size: 24px;
    }
    .progress-stars {
        gap: 5px;
    }
    .star-icon {
        font-size: 18px;
    }
    .info-bar {
        gap: 5px;
    }
    .user-title {
        font-size: 14px;
        padding: 3px 10px;
    }
    .score-box {
        font-size: 14px;
    }
    .level-info {
        font-size: 16px;
        padding: 5px 10px;
    }
}

/* 其他样式 */
.result {display:none;}

.reward {
    margin-top:15px;
    font-size:24px; /* 优化奖励文字 */
    color:#ffd700;
    font-weight:bold;
    text-shadow:0 0 10px #ff9800;
    padding:10px;
    border-radius:12px;
    background:rgba(255, 152, 0, 0.2);
    animation: rewardBounce 1s ease-in-out infinite alternate;
    border: 2px solid #ffd700;
}

@keyframes rewardBounce {
    from {transform:scale(1);}
    to {transform:scale(1.08);}
}

.star {
    position:absolute;
    color:#ffd700;
    font-size:26px; /* 优化星星大小 */
    opacity:0;
    text-shadow:0 0 8px #ff9800;
    animation:fall 2s linear forwards;
    z-index:5;
}

@keyframes fall {
    0%{transform:translateY(-50px) rotate(0deg);opacity:1;}
    100%{transform:translateY(100vh) rotate(360deg);opacity:0;}
}

.level-up-popup {
    position:fixed;
    top:50%;
    left:50%;
    transform:translate(-50%,-50%) scale(0);
    background:#fff;
    border:8px solid #ffd700;
    border-radius:20px;
    box-shadow:0 0 25px rgba(255, 215, 0, 0.7);
    padding:25px;
    width:90%;
    max-width:350px;
    z-index:1000;
    text-align:center;
    animation:popup 0.8s forwards;
}

@keyframes popup {
    0%{transform:translate(-50%,-50%) scale(0);}
    70%{transform:translate(-50%,-50%) scale(1.1);}
    100%{transform:translate(-50%,-50%) scale(1);}
}

.popup-title {
    color:#ff9800;
    font-size:22px; /* 优化弹窗标题 */
    margin-bottom:10px;
    text-shadow:1px 1px 3px rgba(0,0,0,0.2);
}

.popup-desc {
    color:#333;
    font-size:16px; /* 优化弹窗描述 */
    margin-bottom:15px;
    line-height:1.5;
}

.confetti {
    position:absolute;
    width:10px; /* 放大彩带 */
    height:30px;
    opacity:0.9;
    animation:fallConfetti 3s ease-in-out forwards;
    z-index:999;
    border-radius: 3px;
}

@keyframes fallConfetti {
    0%{transform:translateY(-20px) rotate(0deg);opacity:1;}
    100%{transform:translateY(100vh) rotate(720deg);opacity:0;}
}

.btn {
    padding:10px 25px; /* 优化按钮大小 */
    font-size:18px; /* 优化按钮字体 */
    background:#ff9800;
    color:#fff;
    border:none;
    border-radius:15px;
    cursor:pointer;
    margin:10px;
    box-shadow:0 5px 10px rgba(0,0,0,0.2);
    transition: all 0.2s ease;
}

.btn:hover {
    background:#f57c00;
    transform:translateY(-3px);
    box-shadow:0 7px 15px rgba(0,0,0,0.3);
}

/* 提示文本样式：隐藏视觉显示 */
.hint-text {
    display: none; /* 完全隐藏提示文本 */
}

/* 可爱的装饰元素 */
.game-container::before {
    content: "";
    position: absolute;
    top: 10px;
    left: 10px;
    width: 40px; /* 缩小装饰元素 */
    height: 40px;
    background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23e91e63'%3E%3Cpath d='M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z'/%3E%3C/svg%3E") no-repeat center;
    background-size: contain;
    opacity: 0.2;
    z-index: 1;
}

.game-container::after {
    content: "";
    position: absolute;
    top: 10px;
    right: 10px;
    width: 40px; /* 缩小装饰元素 */
    height: 40px;
    background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23ff9800'%3E%3Cpath d='M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-0.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z'/%3E%3C/svg%3E") no-repeat center;
    background-size: contain;
    opacity: 0.2;
    z-index: 1;
}
</style>
</head>
<body>
<div class="game-container">
    <h1 class="title">数学王国大闯关</h1>
    
    <!-- 优化：称号+星星+关卡 合并为一行展示 -->
    <div class="info-bar">
        <div class="user-title" id="userTitle">数学小探员</div>
        <div class="score-box">⭐<span id="score">0</span></div>
        <div class="level-info" id="levelText">关卡1：城堡大门</div>
    </div>

    <!-- 卡通进度条 -->
    <div class="progress-bar">
        <div class="progress-title">本关进度：</div>
        <div class="progress-stars" id="progressStars">
            <span class="star-icon">☆</span>
            <span class="star-icon">☆</span>
            <span class="star-icon">☆</span>
            <span class="star-icon">☆</span>
            <span class="star-icon">☆</span>
            <span class="star-icon">☆</span>
            <span class="star-icon">☆</span>
            <span class="star-icon">☆</span>
        </div>
    </div>

    <!-- 算式和答案区域 -->
    <div class="question-box">
        <span class="question-part" id="questionPart">?</span>
        <span class="answer-display" id="answerDisplay" contenteditable="false"></span>
        <div class="loading-spinner" id="loadingSpinner"></div>
    </div>

    <!-- 提示文本：仅保留语音，隐藏显示 -->
    <div class="hint-text" id="hintText"></div>

    <!-- 符合儿童直觉的数字键盘 -->
    <div class="num-keyboard">
        <button class="num-btn" data-num="1">1</button>
        <button class="num-btn" data-num="2">2</button>
        <button class="num-btn" data-num="3">3</button>
        <button class="num-btn" data-num="4">4</button>
        <button class="num-btn" data-num="5">5</button>
        <button class="num-btn" data-num="6">6</button>
        <button class="num-btn" data-num="7">7</button>
        <button class="num-btn" data-num="8">8</button>
        <button class="num-btn" data-num="9">9</button>
        <button class="num-btn del-btn" id="delBtn">⌫</button>
        <button class="num-btn zero-btn" data-num="0">0</button>
    </div>

    <div class="result" id="result"></div>
    <div class="reward hidden" id="reward"></div>
</div>

<script>
// 题库和关卡配置（二年级适用的数学题）
const questionBank = [
    ["3×5+6=",21],["23+18=",41],["80-56=",24],["7×4=",28],["45-19+27=",53],["9×2=",18],["6+8×3=",30],["72-45=",27],
    ["5×7-10=",25],["36+24=",60],["91-28=",63],["8×6+5=",53],["63-17=",46],["22+7×3=",43],["4×9=",36],["54-29+16=",41],
    ["76-48+35=",63],["9×3+12=",39],["43+29-17=",55],["81-36=",45],["6×5-8=",22],["27+54=",81],["5×8+21=",61],["90-57+23=",56],
    ["88-49+32=",71],["7×6-15=",27],["38+47-29=",56],["6×9+18=",72],["72-38=",34],["4×8+36=",68],["59+26-41=",44],["8×7-20=",36],
    ["9×8-36=",36],["65+28-47=",46],["7×9+13=",76],["84-39+25=",70],["5×9+42=",87],["92-56+19=",55],["6×8-12=",36],["45+38-26=",57]
];
const levelNames = ["城堡大门","花园小径","森林迷宫","湖泊石桥","宝藏屋"];
const rewardTexts = [
    "解锁城堡大门，获得数学小探员称号",
    "穿过花园小径，数学小探员进阶啦",
    "走出森林迷宫，获得数学小能手称号",
    "跨过湖泊石桥，数学小能手超厉害",
    "打开宝藏屋，获得数学小王者称号，解锁金勋章"
];

// 称号配置（简化，适配二年级）
const titleConfig = [
    { score: 5, name: "数学小探员", show: true },
    { score: 15, name: "数学小能手", show: true },
    { score: 25, name: "数学小达人", show: true },
    { score: 35, name: "数学小王者", show: true }
];

// 个性化话术库（更简单的语气，适合二年级）
const praiseTexts = {
    fast: ["真快！", "速度超棒！", "答得又快又准！"],
    streak: ["三连对，厉害！", "连续正确，真棒！", "保持连胜！"],
    easy: ["答对啦！", "真聪明！", "做得好！"],
    medium: ["太棒了！", "优秀！", "完美！"],
    hard: ["太牛了！", "数学小天才！", "太出色了！"]
};

const encourageTexts = {
    close: [
        { easy: "差一点点，再试试", medium: "数值很接近了", hard: "差一点点就对了" },
        { easy: "几乎答对了", medium: "思路没错", hard: "就差最后一步" }
    ],
    wrong: [
        { easy: "加油哦", medium: "没关系，继续努力", hard: "再思考一下" },
        { easy: "再想想呢", medium: "换个算法试试", hard: "要更细心哦" }
    ],
    repeat: [
        { easy: "先算乘除再算加减", medium: "先算分步结果", hard: "回忆一下运算顺序" },
        { easy: "别输错数字哦", medium: "检查一下步骤", hard: "高难度题要专注" }
    ]
};

// 游戏核心变量
let currentLevel = 0, currentQuestion = 0, score = 0, userAnswer = "", isChecking = false;
let errorCount = 0, correctStreak = 0;
let answerStartTime = 0;
let inputTimer = null;
const totalQuestionsPerLevel = 8, answerDelay = 1200, levelUpDelay = 3000;

// 语音合成相关（更简单的参数，适合儿童）
let speechSynthesis = window.speechSynthesis;
let currentUtterance = null;
let speechSettings = {
    rate: 1.0, // 自然语速
    pitch: 1.4, // 可爱的音调
    volume: 0.9,
    voice: null
};

// 获取DOM元素
const levelText = document.getElementById("levelText");
const questionPart = document.getElementById("questionPart");
const answerDisplay = document.getElementById("answerDisplay");
const scoreSpan = document.getElementById("score");
const delBtn = document.getElementById("delBtn");
const numBtns = document.querySelectorAll(".num-btn[data-num]");
const loadingSpinner = document.getElementById("loadingSpinner");
const hintText = document.getElementById("hintText");
const userTitle = document.getElementById("userTitle");
const progressStars = document.getElementById("progressStars");

// 初始化游戏（含本地存储恢复）
function initGame() {
    // 从本地存储恢复状态
    const savedState = localStorage.getItem("mathGameState");
    if (savedState) {
        const state = JSON.parse(savedState);
        currentLevel = state.currentLevel;
        currentQuestion = state.currentQuestion;
        score = state.score;
        scoreSpan.innerText = score;
        levelText.innerText = `关卡${currentLevel + 1}：${levelNames[currentLevel]}`;
        updateUserTitle();
    }

    // 修复：计算有效索引，避免数组越界
    let qIndex = currentLevel * totalQuestionsPerLevel + currentQuestion;
    if (qIndex >= questionBank.length) {
        qIndex = questionBank.length - 1;
        currentLevel = Math.floor(qIndex / totalQuestionsPerLevel);
        currentQuestion = qIndex % totalQuestionsPerLevel;
        levelText.innerText = `关卡${currentLevel + 1}：${levelNames[currentLevel]}`;
    }
    
    // 格式化算式（给运算符加颜色）
    const formattedQuestion = formatQuestion(questionBank[qIndex][0]);
    questionPart.innerHTML = formattedQuestion;
    
    // 重置答案相关
    userAnswer = "";
    answerDisplay.innerText = "";
    answerDisplay.classList.remove("has-value");
    isChecking = false;
    errorCount = 0;
    hintText.innerText = "";
    answerStartTime = Date.now();
    
    // 更新进度条
    updateProgress();
}

// 格式化算式，给运算符添加颜色
function formatQuestion(question) {
    return question.replace(/\+/g, '<span style="color:#e91e63">+</span>')
                   .replace(/-/g, '<span style="color:#2196f3">-</span>')
                   .replace(/×/g, '<span style="color:#ff9800">×</span>');
}

// 更新卡通进度条
function updateProgress() {
    const stars = progressStars.querySelectorAll(".star-icon");
    stars.forEach((star, index) => {
        if (index < currentQuestion) {
            star.innerText = "★";
            star.classList.add("active");
        } else {
            star.innerText = "☆";
            star.classList.remove("active");
        }
    });
}

// 处理数字键点击（智能输入限制）
function handleNumClick(num) {
    if (isChecking) return;
    if (inputTimer) {
        clearTimeout(inputTimer);
        inputTimer = null;
    }
    
    // 智能输入限制 - 根据正确答案位数限制输入
    const qIndex = currentLevel * totalQuestionsPerLevel + currentQuestion;
    const correctAnswer = questionBank[qIndex][1];
    const maxLength = String(correctAnswer).length;
    
    // 禁止首位0
    if (userAnswer === "" && num === "0") return;
    // 超过最大位数则禁止输入
    if (userAnswer.length >= maxLength) return;

    // 按键反馈
    if (navigator.vibrate) navigator.vibrate(15);
    playKeySound();

    userAnswer += num;
    answerDisplay.innerText = userAnswer;
    answerDisplay.classList.add("has-value");

    // 输入自动提交
    if (userAnswer.length === 1) {
        inputTimer = setTimeout(() => {
            autoSubmit();
            inputTimer = null;
        }, 1500);
    } else {
        autoSubmit();
    }
}

// 播放按键音
function playKeySound() {
    try {
        const audio = new Audio("data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJOsndCgfJ+NqGRgXW0tdY2Gk3SHjI+MqGRgXW0tdY2Gk3SHjI+MqGRgXW0tdY2Gk3SHjI+MqGRgXW0tdY2Gk3SHjI+MqGR//wAAAAAAAAAAAP8=");
        audio.volume = 0.5;
        audio.play();
    } catch (e) {
        // 忽略音频播放错误
    }
}

// 自动提交答案
function autoSubmit() {
    if (isChecking) return;
    isChecking = true;
    loadingSpinner.style.display = "block";
    
    setTimeout(() => {
        checkAnswer();
        loadingSpinner.style.display = "none";
        isChecking = false;
    }, 300);
}

// 检查答案
function checkAnswer() {
    const qIndex = currentLevel * totalQuestionsPerLevel + currentQuestion;
    const correctAnswer = questionBank[qIndex][1];
    const userAns = parseInt(userAnswer) || 0;
    const answerTime = Date.now() - answerStartTime;

    // 判断难度
    let difficulty = "easy";
    if (currentLevel >= 1 && currentLevel <= 2) difficulty = "medium";
    if (currentLevel >= 3) difficulty = "hard";

    // 正确处理
    if (userAns === correctAnswer) {
        correctStreak++;
        errorCount = 0;
        score++;
        scoreSpan.innerText = score;
        saveGameState();
        updateUserTitle();

        // 生成表扬话术（简化版，适合二年级）
        let praiseText = "";
        if (answerTime < 1000) {
            praiseText = praiseTexts.fast[Math.floor(Math.random() * praiseTexts.fast.length)];
        } else if (correctStreak % 3 === 0) {
            praiseText = praiseTexts.streak[Math.floor(Math.random() * praiseTexts.streak.length)];
        } else {
            praiseText = praiseTexts[difficulty][Math.floor(Math.random() * praiseTexts[difficulty].length)];
        }
        speakText(praiseText);

        // 星星动画
        createStar();

        // 检查关卡进度
        currentQuestion++;
        if (currentQuestion >= totalQuestionsPerLevel) {
            currentQuestion = 0;
            currentLevel++;
            if (currentLevel >= levelNames.length) {
                currentLevel = levelNames.length - 1;
                showFinalWinner();
                return;
            }
            levelUp();
        } else {
            setTimeout(() => {
                saveGameState();
                initGame();
            }, answerDelay);
        }
    } else {
        // 错误处理
        correctStreak = 0;
        errorCount++;
        let hint = "";

        // 判断错误类型
        const diff = Math.abs(userAns - correctAnswer);
        if (diff <= 2) {
            hint = encourageTexts.close[Math.floor(Math.random() * encourageTexts.close.length)][difficulty];
        } else if (errorCount >= 2) {
            hint = encourageTexts.repeat[Math.floor(Math.random() * encourageTexts.repeat.length)][difficulty];
        } else {
            hint = encourageTexts.wrong[Math.floor(Math.random() * encourageTexts.wrong.length)][difficulty];
        }
        speakText(hint);

        // 重置输入
        userAnswer = "";
        answerDisplay.innerText = "";
        answerDisplay.classList.remove("has-value");
        isChecking = false;
        answerStartTime = Date.now();
    }
}

// 升级处理
function levelUp() {
    saveGameState();

    // 显示升级弹窗
    const popup = document.createElement("div");
    popup.className = "level-up-popup";
    popup.innerHTML = `
        <div class="popup-title">恭喜升级！</div>
        <div class="popup-desc">进入${levelNames[currentLevel]}啦！</div>
        <div class="reward">${rewardTexts[currentLevel]}</div>
    `;
    document.body.appendChild(popup);

    // 彩带动画
    createConfetti();

    // 语音提示
    speakText(`恭喜进入${levelNames[currentLevel]}！`);

    // 延迟后关闭弹窗并初始化下一关
    setTimeout(() => {
        document.body.removeChild(popup);
        levelText.innerText = `关卡${currentLevel + 1}：${levelNames[currentLevel]}`;
        initGame();
    }, levelUpDelay);
}

// 更新用户称号
function updateUserTitle() {
    for (let i = titleConfig.length - 1; i >= 0; i--) {
        if (score >= titleConfig[i].score) {
            userTitle.innerText = titleConfig[i].name;
            userTitle.style.display = "inline-block";
            break;
        }
    }
}

// 保存游戏状态到本地存储
function saveGameState() {
    const state = {
        currentLevel,
        currentQuestion,
        score
    };
    localStorage.setItem("mathGameState", JSON.stringify(state));
}

// 创建星星动画
function createStar() {
    const star = document.createElement("div");
    star.className = "star";
    star.innerText = "★";
    star.style.left = `${Math.random() * 100}vw`;
    star.style.animationDelay = `${Math.random() * 2}s`;
    document.body.appendChild(star);
    setTimeout(() => {
        document.body.removeChild(star);
    }, 2000);
}

// 创建彩带动画
function createConfetti() {
    const colors = ["#ff0000", "#00ff00", "#0000ff", "#ffff00", "#ff00ff", "#00ffff", "#ff9800", "#e91e63"];
    for (let i = 0; i < 60; i++) {
        const confetti = document.createElement("div");
        confetti.className = "confetti";
        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.left = `${Math.random() * 100}vw`;
        confetti.style.animationDelay = `${Math.random() * 3}s`;
        document.body.appendChild(confetti);
        setTimeout(() => {
            document.body.removeChild(confetti);
        }, 3000);
    }
}

// 语音合成（简化参数）
function speakText(text) {
    if (!speechSynthesis || speechSynthesis.speaking) return;

    const utterance = new SpeechSynthesisUtterance(text);
    utterance.rate = speechSettings.rate;
    utterance.pitch = speechSettings.pitch;
    utterance.volume = speechSettings.volume;
    
    // 设置中文语音
    const voices = speechSynthesis.getVoices();
    const chineseVoice = voices.find(voice => voice.lang.includes("zh"));
    if (chineseVoice) utterance.voice = chineseVoice;

    currentUtterance = utterance;
    speechSynthesis.speak(utterance);
}

// 显示最终胜利
function showFinalWinner() {
    const popup = document.createElement("div");
    popup.className = "level-up-popup";
    popup.innerHTML = `
        <div class="popup-title">恭喜通关！</div>
        <div class="popup-desc">你是数学小王者！</div>
        <button class="btn" onclick="resetGame()">重新开始</button>
    `;
    document.body.appendChild(popup);
    speakText("恭喜你成为数学小王者！");
    createConfetti();
}

// 重置游戏
function resetGame() {
    currentLevel = 0;
    currentQuestion = 0;
    score = 0;
    correctStreak = 0;
    errorCount = 0;
    scoreSpan.innerText = 0;
    localStorage.removeItem("mathGameState");
    initGame();
    
    // 移除所有弹窗
    const popups = document.querySelectorAll(".level-up-popup");
    popups.forEach(p => p.remove());
}

// 处理删除键（长按清空功能）
function handleDelClick() {
    if (isChecking) return;
    if (inputTimer) {
        clearTimeout(inputTimer);
        inputTimer = null;
    }
    userAnswer = userAnswer.slice(0, -1);
    answerDisplay.innerText = userAnswer;
    if (!userAnswer) {
        answerDisplay.classList.remove("has-value");
    }
    if (navigator.vibrate) navigator.vibrate(15);
    playKeySound();
}

// 长按删除键清空答案
let longPressTimer = null;
delBtn.addEventListener("mousedown", () => {
    longPressTimer = setTimeout(() => {
        userAnswer = "";
        answerDisplay.innerText = "";
        answerDisplay.classList.remove("has-value");
        if (navigator.vibrate) navigator.vibrate(20);
    }, 500);
});
delBtn.addEventListener("mouseup", () => {
    clearTimeout(longPressTimer);
});
delBtn.addEventListener("mouseleave", () => {
    clearTimeout(longPressTimer);
});

// 绑定事件
numBtns.forEach(btn => {
    btn.addEventListener("click", () => {
        handleNumClick(btn.dataset.num);
    });
});
delBtn.addEventListener("click", handleDelClick);

// 初始化语音
speechSynthesis.onvoiceschanged = function() {
    const voices = speechSynthesis.getVoices();
    const chineseVoice = voices.find(voice => voice.lang.includes("zh"));
    if (chineseVoice) speechSettings.voice = chineseVoice;
};

// 初始化游戏
window.onload = initGame;
</script>
</body>
</html>
